<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>ã‚«ã‚¹ã‚¿ãƒ ç›¤é¢ç·¨é›† - ã·ã‚ˆã·ã‚ˆ Ver.1.9</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #34495e;
        }
        .main-content {
            display: flex;
            gap: 20px;
        }
        .left-panel {
            width: 300px;
            background-color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #bdc3c7;
        }
        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .puyo-palette {
            margin-bottom: 20px;
        }
        .puyo-palette h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        .puyo-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        .puyo-button {
            width: 60px;
            height: 60px;
            border: 3px solid #34495e;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.2s;
        }
        .puyo-button:hover {
            transform: scale(1.1);
        }
        .puyo-button.selected {
            border-color: #e74c3c;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
        }
        .puyo-button.eraser {
            background-color: #95a5a6;
            color: white;
        }
        .puyo-button.red {
            background-color: #e74c3c;
            color: white;
        }
        .puyo-button.blue {
            background-color: #3498db;
            color: white;
        }
        .puyo-button.green {
            background-color: #2ecc71;
            color: white;
        }
        .puyo-button.yellow {
            background-color: #f1c40f;
            color: black;
        }
        .puyo-button.purple {
            background-color: #9b59b6;
            color: white;
        }
        .tools-section {
            margin-bottom: 20px;
        }
        .tools-section h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        .tool-button {
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .tool-button:hover {
            transform: translateY(-2px);
        }
        .tool-button.clear {
            background-color: #e74c3c;
            color: white;
        }
        .tool-button.save {
            background-color: #27ae60;
            color: white;
        }
        .tool-button.load {
            background-color: #3498db;
            color: white;
        }
        .tool-button.apply {
            background-color: #f39c12;
            color: white;
        }
        .tool-button.preview {
            background-color: #9b59b6;
            color: white;
        }
        .custom-stage {
            position: relative;
            border: 3px solid #34495e;
            border-radius: 8px;
            background-color: #ffffff;
            margin-bottom: 20px;
        }
        .custom-stage-cell {
            position: absolute;
            width: 32px;
            height: 32px;
            border: 1px solid #bdc3c7;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            transition: all 0.1s;
        }
        .custom-stage-cell:hover {
            background-color: rgba(52, 152, 219, 0.2);
        }
        .info-panel {
            background-color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #bdc3c7;
            margin-top: 10px;
        }
        .field-code-display {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ® ã‚«ã‚¹ã‚¿ãƒ ç›¤é¢ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ Ver.1.9</h1>
            <p>ã·ã‚ˆã‚’é…ç½®ã—ã¦è‡ªç”±ã«ç›¤é¢ã‚’ä½œæˆã§ãã¾ã™</p>
        </div>
        
        <div class="main-content">
            <div class="left-panel">
                <!-- ã·ã‚ˆãƒ‘ãƒ¬ãƒƒãƒˆ -->
                <div class="puyo-palette">
                    <h3>ğŸ¨ ã·ã‚ˆãƒ‘ãƒ¬ãƒƒãƒˆ</h3>
                    <div class="puyo-buttons">
                        <div class="puyo-button eraser selected" data-puyo="0">æ¶ˆå»</div>
                        <div class="puyo-button red" data-puyo="1">èµ¤</div>
                        <div class="puyo-button blue" data-puyo="2">é’</div>
                        <div class="puyo-button green" data-puyo="3">ç·‘</div>
                        <div class="puyo-button yellow" data-puyo="4">é»„</div>
                        <div class="puyo-button purple" data-puyo="5">ç´«</div>
                    </div>
                </div>
                
                <!-- ãƒ„ãƒ¼ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="tools-section">
                    <h3>ğŸ”§ ãƒ„ãƒ¼ãƒ«</h3>
                    <button class="tool-button clear" onclick="CustomEditor.clearField()">ğŸ—‘ï¸ ç›¤é¢ã‚¯ãƒªã‚¢</button>
                    <button class="tool-button save" onclick="CustomEditor.saveField()">ğŸ’¾ ç›¤é¢ä¿å­˜</button>
                    <button class="tool-button load" onclick="CustomEditor.loadField()">ğŸ“‚ ç›¤é¢èª­ã¿è¾¼ã¿</button>
                    <button class="tool-button load" onclick="CustomEditor.importExternalField()">ğŸŒ å¤–éƒ¨ã‚³ãƒ¼ãƒ‰èª­ã¿è¾¼ã¿</button>
                    <button class="tool-button apply" onclick="CustomEditor.applyToMain()">âœ… ãƒ¡ã‚¤ãƒ³ç›¤é¢ã«é©ç”¨</button>
                    <button class="tool-button preview" onclick="CustomEditor.previewChain()">ğŸ” é€£é–ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
                </div>
                
                <!-- ãƒ—ãƒªã‚»ãƒƒãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="tools-section">
                    <h3>ğŸ“‹ ãƒ—ãƒªã‚»ãƒƒãƒˆ</h3>
                    <button class="tool-button load" onclick="CustomEditor.loadPreset('chain_seed_1')">2é€£é–ã®ç¨®</button>
                    <button class="tool-button load" onclick="CustomEditor.loadPreset('chain_seed_2')">3é€£é–ã®ç¨®</button>
                    <button class="tool-button load" onclick="CustomEditor.loadPreset('chain_seed_3')">4é€£é–ã®ç¨®</button>
                    <button class="tool-button load" onclick="CustomEditor.loadPreset('big_chain_1')">5é€£é–</button>
                    <button class="tool-button load" onclick="CustomEditor.loadPreset('big_chain_2')">7é€£é–</button>
                    <button class="tool-button load" onclick="CustomEditor.loadPreset('big_chain_3')">10é€£é–</button>
                    <button class="tool-button load" onclick="CustomEditor.loadPreset('test_17chain')" style="background-color: #e74c3c;">17é€£é–ãƒ†ã‚¹ãƒˆ</button>
                </div>
            </div>
            
            <div class="right-panel">
                <!-- ã‚«ã‚¹ã‚¿ãƒ ç›¤é¢ã‚¨ãƒªã‚¢ -->
                <div id="custom-stage" class="custom-stage">
                    <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                </div>
                
                <!-- æƒ…å ±ãƒ‘ãƒãƒ« -->
                <div class="info-panel">
                    <h3>ğŸ“Š ç›¤é¢æƒ…å ±</h3>
                    <div>é…ç½®ã•ã‚ŒãŸã·ã‚ˆæ•°: <span id="puyo-count">0</span></div>
                    <div>é¸æŠä¸­ã®ã·ã‚ˆ: <span id="selected-puyo">æ¶ˆå»</span></div>
                    
                    <div class="field-code-display">
                        <strong>ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚³ãƒ¼ãƒ‰:</strong><br>
                        <span id="field-code">000000000000000000000000000000000000000000000000000000000000000000000000</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã®è¨­å®š
        const STAGE_ROWS = 12;
        const STAGE_COLS = 6;
        const CELL_SIZE = 32;
        
        class CustomEditor {
            static selectedPuyo = 0;
            static board = [];
            static puyoCount = 0;
            
            static initialize() {
                this.createStage();
                this.setupEventListeners();
                this.updateDisplay();
            }
            
            static createStage() {
                const stageElement = document.getElementById('custom-stage');
                stageElement.style.width = (STAGE_COLS * CELL_SIZE) + 'px';
                stageElement.style.height = (STAGE_ROWS * CELL_SIZE) + 'px';
                
                // ç›¤é¢åˆæœŸåŒ–
                this.board = [];
                for (let y = 0; y < STAGE_ROWS; y++) {
                    this.board[y] = [];
                    for (let x = 0; x < STAGE_COLS; x++) {
                        this.board[y][x] = 0;
                        
                        const cell = document.createElement('div');
                        cell.className = 'custom-stage-cell';
                        cell.style.left = (x * CELL_SIZE) + 'px';
                        cell.style.top = (y * CELL_SIZE) + 'px';
                        cell.dataset.x = x;
                        cell.dataset.y = y;
                        
                        cell.addEventListener('click', () => {
                            this.placePuyo(x, y);
                        });
                        
                        stageElement.appendChild(cell);
                    }
                }
            }
            
            static setupEventListeners() {
                // ã·ã‚ˆãƒ‘ãƒ¬ãƒƒãƒˆã®ã‚¯ãƒªãƒƒã‚¯
                document.querySelectorAll('.puyo-button').forEach(button => {
                    button.addEventListener('click', () => {
                        document.querySelectorAll('.puyo-button').forEach(b => b.classList.remove('selected'));
                        button.classList.add('selected');
                        this.selectedPuyo = parseInt(button.dataset.puyo);
                        this.updateSelectedPuyoDisplay();
                    });
                });
            }
            
            static placePuyo(x, y) {
                if (this.board[y][x] !== 0) {
                    this.puyoCount--;
                }
                
                this.board[y][x] = this.selectedPuyo;
                
                if (this.selectedPuyo !== 0) {
                    this.puyoCount++;
                }
                
                this.updateCellDisplay(x, y);
                this.updateDisplay();
            }
            
            static updateCellDisplay(x, y) {
                const cell = document.querySelector(`[data-x="${x}"][data-y="${y}"]`);
                const puyoType = this.board[y][x];
                
                // ã‚»ãƒ«ã®èƒŒæ™¯è‰²ã¨ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
                const puyoStyles = {
                    0: { bg: '#ffffff', text: '', color: '#000000' },
                    1: { bg: '#e74c3c', text: 'èµ¤', color: '#ffffff' },
                    2: { bg: '#3498db', text: 'é’', color: '#ffffff' },
                    3: { bg: '#2ecc71', text: 'ç·‘', color: '#ffffff' },
                    4: { bg: '#f1c40f', text: 'é»„', color: '#000000' },
                    5: { bg: '#9b59b6', text: 'ç´«', color: '#ffffff' }
                };
                
                const style = puyoStyles[puyoType];
                cell.style.backgroundColor = style.bg;
                cell.style.color = style.color;
                cell.textContent = style.text;
            }
            
            static updateDisplay() {
                document.getElementById('puyo-count').textContent = this.puyoCount;
                document.getElementById('field-code').textContent = this.generateFieldCode();
            }
            
            static updateSelectedPuyoDisplay() {
                const puyoNames = ['æ¶ˆå»', 'èµ¤', 'é’', 'ç·‘', 'é»„', 'ç´«'];
                document.getElementById('selected-puyo').textContent = puyoNames[this.selectedPuyo];
            }
            
            static generateFieldCode() {
                let code = '';
                for (let y = 0; y < STAGE_ROWS; y++) {
                    for (let x = 0; x < STAGE_COLS; x++) {
                        code += this.board[y][x];
                    }
                }
                return code;
            }
            
            static loadFieldFromCode(code) {
                if (code.length !== STAGE_ROWS * STAGE_COLS) {
                    alert('ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚³ãƒ¼ãƒ‰ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                    return false;
                }
                
                this.puyoCount = 0;
                for (let y = 0; y < STAGE_ROWS; y++) {
                    for (let x = 0; x < STAGE_COLS; x++) {
                        const index = y * STAGE_COLS + x;
                        const puyoType = parseInt(code[index]);
                        this.board[y][x] = puyoType;
                        
                        if (puyoType !== 0) {
                            this.puyoCount++;
                        }
                        
                        this.updateCellDisplay(x, y);
                    }
                }
                
                this.updateDisplay();
                return true;
            }
            
            static clearField() {
                if (confirm('ç›¤é¢ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                    this.puyoCount = 0;
                    for (let y = 0; y < STAGE_ROWS; y++) {
                        for (let x = 0; x < STAGE_COLS; x++) {
                            this.board[y][x] = 0;
                            this.updateCellDisplay(x, y);
                        }
                    }
                    this.updateDisplay();
                }
            }
            
            static saveField() {
                const name = prompt('ä¿å­˜åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', `ã‚«ã‚¹ã‚¿ãƒ ç›¤é¢_${new Date().toLocaleDateString()}`);
                if (name && name.trim()) {
                    const savedFields = JSON.parse(localStorage.getItem('puyoSavedFields') || '{}');
                    savedFields[name.trim()] = {
                        code: this.generateFieldCode(),
                        date: new Date().toISOString()
                    };
                    localStorage.setItem('puyoSavedFields', JSON.stringify(savedFields));
                    alert('ç›¤é¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                }
            }
            
            static loadField() {
                const savedFields = JSON.parse(localStorage.getItem('puyoSavedFields') || '{}');
                if (Object.keys(savedFields).length === 0) {
                    alert('ä¿å­˜æ¸ˆã¿ã®ç›¤é¢ãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                this.showLoadFieldModal(savedFields);
            }
            
            // ç›¤é¢èª­ã¿è¾¼ã¿ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            static showLoadFieldModal(savedFields) {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0,0,0,0.7);
                    z-index: 1000;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                `;
                
                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background-color: white;
                    padding: 20px;
                    border-radius: 10px;
                    max-width: 500px;
                    max-height: 80vh;
                    overflow-y: auto;
                `;
                
                let content = '<h3 style="margin-top: 0;">ä¿å­˜æ¸ˆã¿ç›¤é¢ã®èª­ã¿è¾¼ã¿</h3>';
                content += '<div style="margin-bottom: 15px;">';
                
                Object.entries(savedFields).forEach(([name, data]) => {
                    const date = new Date(data.date).toLocaleDateString();
                    content += `
                        <div style="border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 5px; cursor: pointer;" 
                             onclick="CustomEditor.loadSelectedField('${name}'); document.body.removeChild(this.closest('.load-modal'));">
                            <strong>${name}</strong><br>
                            <small>ä¿å­˜æ—¥: ${date}</small>
                        </div>
                    `;
                });
                
                content += '</div>';
                content += `
                    <button onclick="document.body.removeChild(this.closest('.load-modal'))" style="
                        padding: 8px 16px;
                        background-color: #e74c3c;
                        color: white;
                        border: none;
                        border-radius: 5px;
                        cursor: pointer;
                    ">é–‰ã˜ã‚‹</button>
                `;
                
                modalContent.innerHTML = content;
                modal.className = 'load-modal';
                modal.appendChild(modalContent);
                
                // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                });
                
                document.body.appendChild(modal);
            }
            
            // é¸æŠã•ã‚ŒãŸç›¤é¢ã‚’èª­ã¿è¾¼ã¿
            static loadSelectedField(name) {
                const savedFields = JSON.parse(localStorage.getItem('puyoSavedFields') || '{}');
                if (savedFields[name]) {
                    this.loadFieldFromCode(savedFields[name].code);
                    alert('ç›¤é¢ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                } else {
                    alert('ç›¤é¢ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
            }
            
            // å¤–éƒ¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚³ãƒ¼ãƒ‰èª­ã¿è¾¼ã¿
            static importExternalField() {
                this.showImportFieldModal();
            }
            
            // å¤–éƒ¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚³ãƒ¼ãƒ‰èª­ã¿è¾¼ã¿ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            static showImportFieldModal() {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0,0,0,0.7);
                    z-index: 1000;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                `;
                
                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background-color: white;
                    padding: 20px;
                    border-radius: 10px;
                    max-width: 500px;
                    max-height: 80vh;
                    overflow-y: auto;
                `;
                
                modalContent.innerHTML = `
                    <h3 style="margin-top: 0;">å¤–éƒ¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚³ãƒ¼ãƒ‰èª­ã¿è¾¼ã¿</h3>
                    <div style="margin-bottom: 15px;">
                        <label for="external-field-code">ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:</label><br>
                        <textarea id="external-field-code" style="
                            width: 100%; 
                            height: 100px; 
                            margin-top: 5px; 
                            padding: 5px; 
                            border: 1px solid #ccc; 
                            border-radius: 3px;
                            font-family: monospace;
                        " placeholder="72æ–‡å­—ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›..."></textarea>
                    </div>
                    <div style="text-align: center;">
                        <button onclick="CustomEditor.loadExternalFieldCode()" style="
                            padding: 8px 16px;
                            background-color: #27ae60;
                            color: white;
                            border: none;
                            border-radius: 5px;
                            cursor: pointer;
                            margin-right: 10px;
                        ">èª­ã¿è¾¼ã¿</button>
                        <button onclick="document.body.removeChild(this.closest('.import-modal'))" style="
                            padding: 8px 16px;
                            background-color: #e74c3c;
                            color: white;
                            border: none;
                            border-radius: 5px;
                            cursor: pointer;
                        ">é–‰ã˜ã‚‹</button>
                    </div>
                `;
                
                modal.className = 'import-modal';
                modal.appendChild(modalContent);
                
                // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                });
                
                document.body.appendChild(modal);
            }
            
            // å¤–éƒ¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã¿
            static loadExternalFieldCode() {
                const code = document.getElementById('external-field-code').value.trim();
                if (code) {
                    if (this.loadFieldFromCode(code)) {
                        alert('å¤–éƒ¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                        document.body.removeChild(document.querySelector('.import-modal'));
                    }
                } else {
                    alert('ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                }
            }
            
            static applyToMain() {
                if (confirm('ãƒ¡ã‚¤ãƒ³ç›¤é¢ã«é©ç”¨ã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®ç›¤é¢ã¯å¤±ã‚ã‚Œã¾ã™ã€‚')) {
                    if (window.opener && window.opener.SideMenu) {
                        window.opener.SideMenu.loadFieldFromCode(this.generateFieldCode());
                        alert('ãƒ¡ã‚¤ãƒ³ç›¤é¢ã«é©ç”¨ã—ã¾ã—ãŸ');
                    } else {
                        alert('ãƒ¡ã‚¤ãƒ³ç”»é¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    }
                }
            }
            
            static previewChain() {
                const chainResult = this.simulateChain();
                
                if (chainResult.steps.length === 0) {
                    alert('ã“ã®ç›¤é¢ã§ã¯é€£é–ãŒç™ºç”Ÿã—ã¾ã›ã‚“ã€‚');
                    return;
                }
                
                // é€£é–çµæœã‚’è¡¨ç¤º
                this.showChainResult(chainResult);
            }
            
            // é€£é–ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
            static simulateChain() {
                // ç¾åœ¨ã®ç›¤é¢ã‚’ã‚³ãƒ”ãƒ¼
                const previewBoard = [];
                for (let y = 0; y < STAGE_ROWS; y++) {
                    previewBoard[y] = [...this.board[y]];
                }
                
                const chainSteps = [];
                let chainCount = 0;
                let totalScore = 0;
                
                while (true) {
                    // è½ä¸‹å‡¦ç†
                    this.simulateFall(previewBoard);
                    
                    // æ¶ˆå»åˆ¤å®š
                    const eraseResult = this.simulateErase(previewBoard);
                    if (!eraseResult) {
                        break; // æ¶ˆå»ã§ããªã„å ´åˆã¯é€£é–çµ‚äº†
                    }
                    
                    chainCount++;
                    const chainScore = this.calculateChainScore(eraseResult, chainCount);
                    totalScore += chainScore;
                    
                    // é€£é–ã‚¹ãƒ†ãƒƒãƒ—ã‚’ä¿å­˜
                    chainSteps.push({
                        step: chainCount,
                        erasedCount: eraseResult.erasedPuyos.length,
                        colorCount: eraseResult.colorCount,
                        chainScore: chainScore,
                        totalScore: totalScore
                    });
                    
                    // ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢
                    if (chainCount > 20) {
                        break;
                    }
                }
                
                return {
                    steps: chainSteps,
                    totalChains: chainCount,
                    finalScore: totalScore
                };
            }
            
            // è½ä¸‹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
            static simulateFall(board) {
                let hasChanges = true;
                while (hasChanges) {
                    hasChanges = false;
                    for (let y = STAGE_ROWS - 2; y >= 0; y--) {
                        for (let x = 0; x < STAGE_COLS; x++) {
                            if (board[y][x] !== 0 && board[y + 1][x] === 0) {
                                board[y + 1][x] = board[y][x];
                                board[y][x] = 0;
                                hasChanges = true;
                            }
                        }
                    }
                }
            }
            
            // æ¶ˆå»ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
            static simulateErase(board) {
                const toErase = [];
                const visited = [];
                
                // åˆæœŸåŒ–
                for (let y = 0; y < STAGE_ROWS; y++) {
                    visited[y] = [];
                    for (let x = 0; x < STAGE_COLS; x++) {
                        visited[y][x] = false;
                    }
                }
                
                // é€£ç¶šã™ã‚‹ã·ã‚ˆã‚’æ¢ã™
                for (let y = 0; y < STAGE_ROWS; y++) {
                    for (let x = 0; x < STAGE_COLS; x++) {
                        if (!visited[y][x] && board[y][x] >= 1 && board[y][x] <= 5) {
                            const connected = this.findConnectedPuyos(x, y, board[y][x], visited, board);
                            if (connected.length >= 4) { // ã·ã‚ˆã·ã‚ˆã¯4å€‹ä»¥ä¸Šã§æ¶ˆå»
                                toErase.push(...connected);
                            }
                        }
                    }
                }
                
                if (toErase.length === 0) {
                    return null;
                }
                
                // æ¶ˆå»å®Ÿè¡Œ
                const colorCount = {};
                for (const pos of toErase) {
                    const color = board[pos.y][pos.x];
                    colorCount[color] = (colorCount[color] || 0) + 1;
                    board[pos.y][pos.x] = 0;
                }
                
                return {
                    erasedPuyos: toErase,
                    pieceCount: toErase.length,
                    colorCount: Object.keys(colorCount).length
                };
            }
            
            // é€£ç¶šã™ã‚‹ã·ã‚ˆã‚’æ¢ã™
            static findConnectedPuyos(startX, startY, targetColor, visited, board) {
                const connected = [];
                const stack = [{x: startX, y: startY}];
                
                while (stack.length > 0) {
                    const {x, y} = stack.pop();
                    
                    if (x < 0 || x >= STAGE_COLS || y < 0 || y >= STAGE_ROWS) continue;
                    if (visited[y][x]) continue;
                    if (board[y][x] !== targetColor) continue;
                    
                    visited[y][x] = true;
                    connected.push({x, y});
                    
                    // 4æ–¹å‘ã«æ¢ç´¢
                    stack.push({x: x + 1, y: y});
                    stack.push({x: x - 1, y: y});
                    stack.push({x: x, y: y + 1});
                    stack.push({x: x, y: y - 1});
                }
                
                return connected;
            }
            
            // é€£é–ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—
            static calculateChainScore(eraseResult, chainCount) {
                const baseScore = eraseResult.pieceCount * 10;
                const chainBonus = Math.pow(2, chainCount - 1);
                const colorBonus = eraseResult.colorCount * 3;
                return Math.floor(baseScore * chainBonus + colorBonus);
            }
            
            // é€£é–çµæœã‚’è¡¨ç¤º
            static showChainResult(result) {
                let message = `ğŸ‰ é€£é–ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ ğŸ‰\n\n`;
                message += `ç·é€£é–æ•°: ${result.totalChains}é€£é–\n`;
                message += `æœ€çµ‚ã‚¹ã‚³ã‚¢: ${result.finalScore}ç‚¹\n\n`;
                message += `--- é€£é–è©³ç´° ---\n`;
                
                result.steps.forEach((step, index) => {
                    message += `${step.step}é€£é–ç›®: ${step.erasedCount}å€‹æ¶ˆå» (${step.chainScore}ç‚¹)\n`;
                });
                
                alert(message);
            }
            
            static loadPreset(presetType) {
                const presets = {
                    'chain_seed_1': '000000000000000000000000000000000000000000000000000000001100001200001200',
                    'chain_seed_2': '000000000000000000000000000000000000000000001100001200001200001300001300',
                    'chain_seed_3': '000000000000000000000000000000001100001200001200001300001300001400001400',
                    'big_chain_1': '000000000000000000000000112300112300112300445500445500445500445500445500',
                    'big_chain_2': '000000000000112300112300112300445500445500445500112300112300445500445500',
                    'big_chain_3': '112300112300112300112300445500445500445500445500112300445500112300445500',
                    'test_17chain': '034350034353234354103435245124245124451234245123234513123451123451123451'  // Ver.1.8ã§è¿½åŠ : 17é€£é–ãƒ†ã‚¹ãƒˆç”¨
                };
                
                if (presets[presetType]) {
                    if (confirm('ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®ç›¤é¢ã¯å¤±ã‚ã‚Œã¾ã™ã€‚')) {
                        this.loadFieldFromCode(presets[presetType]);
                        alert('ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                    }
                }
            }
        }
        
        // åˆæœŸåŒ–
        window.addEventListener('load', () => {
            CustomEditor.initialize();
        });
    </script>
</body>
</html>